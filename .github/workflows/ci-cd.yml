name: SmartFlowAI CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "18"

jobs:
  # ===== JOB 1: TESTY JEDNOSTKOWE =====
  test:
    name: ğŸ§ª Testy jednostkowe
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
      - name: ğŸ“¥ Checkout kodu
        uses: actions/checkout@v4

      - name: ğŸ Konfiguracja Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ“¦ Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ğŸ”§ Instalacja zaleÅ¼noÅ›ci
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist flake8 black isort

      - name: ğŸ¯ Konfiguracja zmiennych Å›rodowiskowych testowych
        run: |
          echo "OPENAI_API_KEY=test-openai-key-12345" >> $GITHUB_ENV
          echo "SUPABASE_URL=https://test.supabase.co" >> $GITHUB_ENV
          echo "SUPABASE_ANON_KEY=test-supabase-anon-key-12345" >> $GITHUB_ENV
          echo "ENVIRONMENT=test" >> $GITHUB_ENV

      - name: ğŸ” Linting z flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: ğŸ¨ Sprawdzenie formatowania kodu
        run: |
          black --check --diff .
          isort --check-only --diff .

      - name: ğŸ§ª Uruchomienie testÃ³w produkcyjnych
        run: |
          python -m pytest test_production_ready.py -v --tb=short --cov=. --cov-report=xml

      - name: ğŸ§ª Uruchomienie testÃ³w funkcji AI
        run: |
          python -m pytest test_enhanced_analysis.py -v --tb=short

      - name: ğŸ§ª Uruchomienie testÃ³w kodowania UTF-8
        run: |
          python -m pytest test_utf8.py -v --tb=short

      - name: ğŸ§ª PeÅ‚ny test runner
        run: |
          python run_tests.py

      - name: ğŸ“Š Upload coverage do Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # ===== JOB 2: TESTY BEZPIECZEÅƒSTWA =====
  security:
    name: ğŸ”’ Testy bezpieczeÅ„stwa
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ğŸ“¥ Checkout kodu
        uses: actions/checkout@v4

      - name: ğŸ Konfiguracja Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ”§ Instalacja narzÄ™dzi bezpieczeÅ„stwa
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety
          pip install -r requirements.txt

      - name: ğŸ›¡ï¸ Skanowanie kodu z Bandit
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -f txt

      - name: ğŸ” Sprawdzenie podatnoÅ›ci w zaleÅ¼noÅ›ciach
        run: |
          safety check --json --output safety-report.json || true
          safety check

      - name: ğŸ“¤ Upload raportÃ³w bezpieczeÅ„stwa
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  # ===== JOB 3: BUILD APLIKACJI =====
  build:
    name: ğŸ—ï¸ Build aplikacji
    runs-on: ubuntu-latest
    needs: [test, security]

    steps:
      - name: ğŸ“¥ Checkout kodu
        uses: actions/checkout@v4

      - name: ğŸ Konfiguracja Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ”§ Instalacja zaleÅ¼noÅ›ci
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install build wheel

      - name: ğŸ—ï¸ Budowanie pakietu
        run: |
          python -m build

      - name: ğŸ“¦ Tworzenie artefaktu aplikacji
        run: |
          mkdir -p dist/smartflowai
          cp -r *.py dist/smartflowai/
          cp requirements.txt dist/smartflowai/
          cp -r .streamlit dist/smartflowai/ 2>/dev/null || true
          tar -czf smartflowai-app.tar.gz -C dist smartflowai

      - name: ğŸ“¤ Upload artefaktÃ³w
        uses: actions/upload-artifact@v3
        with:
          name: smartflowai-build
          path: |
            dist/
            smartflowai-app.tar.gz
          retention-days: 30

  # ===== JOB 4: DOCKER BUILD =====
  docker:
    name: ğŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout kodu
        uses: actions/checkout@v4

      - name: ğŸ³ Konfiguracja Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Login do Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Build i push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/smartflowai:latest
            ${{ secrets.DOCKER_USERNAME }}/smartflowai:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===== JOB 5: DEPLOYMENT STAGING =====
  deploy-staging:
    name: ğŸš€ Deploy do Staging
    runs-on: ubuntu-latest
    needs: [build, docker]
    if: github.ref == 'refs/heads/develop'
    environment: staging

    steps:
      - name: ğŸ“¥ Checkout kodu
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download artefaktÃ³w
        uses: actions/download-artifact@v3
        with:
          name: smartflowai-build

      - name: ğŸš€ Deploy do Streamlit Cloud (Staging)
        run: |
          echo "ğŸš€ Deploying to Staging environment..."
          echo "ğŸ“¦ Artifact downloaded and ready for deployment"
          # Tutaj moÅ¼na dodaÄ‡ rzeczywisty deployment do Streamlit Cloud
          # lub innej platformy staging

      - name: ğŸ§ª Testy smoke na staging
        run: |
          echo "ğŸ§ª Running smoke tests on staging..."
          # Tutaj moÅ¼na dodaÄ‡ testy smoke sprawdzajÄ…ce czy aplikacja dziaÅ‚a
          sleep 5
          echo "âœ… Staging deployment successful!"

  # ===== JOB 6: DEPLOYMENT PRODUCTION =====
  deploy-production:
    name: ğŸŒŸ Deploy do Production
    runs-on: ubuntu-latest
    needs: [build, docker]
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: ğŸ“¥ Checkout kodu
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download artefaktÃ³w
        uses: actions/download-artifact@v3
        with:
          name: smartflowai-build

      - name: ğŸŒŸ Deploy do Production
        run: |
          echo "ğŸŒŸ Deploying to Production environment..."
          echo "ğŸ“¦ Artifact downloaded and ready for deployment"
          # Tutaj moÅ¼na dodaÄ‡ rzeczywisty deployment do produkcji

      - name: ğŸ§ª Testy smoke na production
        run: |
          echo "ğŸ§ª Running smoke tests on production..."
          # Tutaj moÅ¼na dodaÄ‡ testy smoke sprawdzajÄ…ce czy aplikacja dziaÅ‚a
          sleep 5
          echo "âœ… Production deployment successful!"

      - name: ğŸ“¢ Powiadomienie o deployment
        run: |
          echo "ğŸ“¢ SmartFlowAI successfully deployed to production!"
          echo "ğŸ”— Application URL: https://your-app-url.com"

  # ===== JOB 7: MONITORING I ALERTY =====
  monitoring:
    name: ğŸ“Š Monitoring i alerty
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“Š Sprawdzenie statusu aplikacji
        run: |
          echo "ğŸ“Š Checking application health..."
          # Tutaj moÅ¼na dodaÄ‡ sprawdzenie health check endpoint
          sleep 3
          echo "âœ… Application is healthy!"

      - name: ğŸ“§ Powiadomienie Slack/Teams
        run: |
          echo "ğŸ“§ Sending deployment notification..."
          # Tutaj moÅ¼na dodaÄ‡ integracjÄ™ z Slack/Teams
          echo "âœ… Notification sent!"

  # ===== JOB 8: CLEANUP =====
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-staging]
    if: always()

    steps:
      - name: ğŸ§¹ Cleanup starych artefaktÃ³w
        run: |
          echo "ğŸ§¹ Cleaning up old artifacts..."
          # Tutaj moÅ¼na dodaÄ‡ cleanup starych buildÃ³w
          echo "âœ… Cleanup completed!"
