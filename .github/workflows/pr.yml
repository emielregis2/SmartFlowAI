# Plik: .github/workflows/pr.yml
# .github/workflows/pr.yml - CI dla Pull RequestÃ³w SmartFlowAI

name: ğŸ”„ Pull Request Check

on:
  pull_request:
    branches: [ main, master ]
    types: [opened, synchronize, reopened]

env:
  PYTHON_VERSION: 3.11

jobs:
  pr-check:
    name: ğŸ” PR Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout PR code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black pytest
    
    - name: ğŸ¨ Check code formatting
      run: |
        echo "ğŸ¨ Checking code formatting with Black..."
        black --check --diff . || (echo "âŒ Code formatting issues found. Run 'black .' to fix." && exit 1)
    
    - name: ğŸ” Lint code
      run: |
        echo "ğŸ” Linting code with flake8..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    
    - name: ğŸ§ª Run tests
      env:
        OPENAI_API_KEY: 'sk-test-key-for-pr'
        SUPABASE_URL: 'https://test.supabase.co'
        SUPABASE_ANON_KEY: 'test-key'
      run: |
        echo "ğŸ§ª Running tests..."
        pytest test_app.py -v --tb=short
    
    - name: ğŸ“Š Check file sizes
      run: |
        echo "ğŸ“Š Checking file sizes..."
        find . -name "*.py" -size +100k -exec echo "âš ï¸  Large file: {}" \;
        echo "âœ… File size check completed"
    
    - name: ğŸ¯ PR Summary
      run: |
        echo "## ğŸ¯ SmartFlowAI PR Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Code formatting: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Linting: Passed" >> $GITHUB_STEP_SUMMARY  
        echo "- âœ… Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… File sizes: OK" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸš€ Ready to merge!" >> $GITHUB_STEP_SUMMARY

  pr-preview:
    name: ğŸ”— Generate Preview Link
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    
    steps:
    - name: ğŸ“ Add preview comment
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ”— SmartFlowAI Preview
            
            Thank you for your PR! Here are some useful links:
            
            - ğŸ“± **Streamlit App**: Will auto-deploy when merged to main
            - ğŸ§ª **Test Results**: Check the Actions tab above
            - ğŸ“Š **Code Coverage**: See the CI job results
            
            ### ğŸ” Quick Review Checklist:
            - [ ] Tests pass locally (\`pytest test_app.py\`)
            - [ ] Code formatted (\`black .\`)
            - [ ] No sensitive data in commits
            - [ ] PR description explains changes
            
            Auto-generated by SmartFlowAI CI ğŸ¤–`
          })