# Plik: .github/workflows/pr.yml
# .github/workflows/pr.yml - CI dla Pull Requestów SmartFlowAI

name: 🔄 Pull Request Check

on:
  pull_request:
    branches: [ main, master ]
    types: [opened, synchronize, reopened]

env:
  PYTHON_VERSION: 3.11

jobs:
  pr-check:
    name: 🔍 PR Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout PR code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: 🐍 Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: 📦 Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black pytest
    
    - name: 🎨 Check code formatting
      run: |
        echo "🎨 Checking code formatting with Black..."
        black --check --diff . || (echo "❌ Code formatting issues found. Run 'black .' to fix." && exit 1)
    
    - name: 🔍 Lint code
      run: |
        echo "🔍 Linting code with flake8..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    
    - name: 🧪 Run tests
      env:
        OPENAI_API_KEY: 'sk-test-key-for-pr'
        SUPABASE_URL: 'https://test.supabase.co'
        SUPABASE_ANON_KEY: 'test-key'
      run: |
        echo "🧪 Running tests..."
        pytest test_app.py -v --tb=short
    
    - name: 📊 Check file sizes
      run: |
        echo "📊 Checking file sizes..."
        find . -name "*.py" -size +100k -exec echo "⚠️  Large file: {}" \;
        echo "✅ File size check completed"
    
    - name: 🎯 PR Summary
      run: |
        echo "## 🎯 SmartFlowAI PR Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Code formatting: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Linting: Passed" >> $GITHUB_STEP_SUMMARY  
        echo "- ✅ Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ File sizes: OK" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🚀 Ready to merge!" >> $GITHUB_STEP_SUMMARY

  pr-preview:
    name: 🔗 Generate Preview Link
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    
    steps:
    - name: 📝 Add preview comment
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## 🔗 SmartFlowAI Preview
            
            Thank you for your PR! Here are some useful links:
            
            - 📱 **Streamlit App**: Will auto-deploy when merged to main
            - 🧪 **Test Results**: Check the Actions tab above
            - 📊 **Code Coverage**: See the CI job results
            
            ### 🔍 Quick Review Checklist:
            - [ ] Tests pass locally (\`pytest test_app.py\`)
            - [ ] Code formatted (\`black .\`)
            - [ ] No sensitive data in commits
            - [ ] PR description explains changes
            
            Auto-generated by SmartFlowAI CI 🤖`
          })